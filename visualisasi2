import pandas as pd
import plotly.graph_objects as go

# Mengatur file path dan sheet name
file_path = '/Users/macbookair/Documents/pyhton folder/Virtual Pyhton/Data  Izin All - DPMPTSP - Dimas.xlsx'
sheet_name = 'Data Izin All'

# Membaca data dari Excel
df = pd.read_excel(file_path, sheet_name=sheet_name)

# Filter data untuk 'Kantor Lurah Balimester'
filtered_df = df[df['service_point'] == 'Kantor Lurah Balimester']

if filtered_df.empty:
    print("Tidak ada data untuk 'Kantor Lurah Balimester'.")
else:
    # Menghitung total izin berdasarkan status
    total_izin_diajukan = filtered_df['total_diajukan'].sum()
    total_selesai = filtered_df['total_selesai'].sum()
    total_ditolak_dibatalkan = filtered_df['total_di_tolak'].sum() + filtered_df['total_dibatalkan'].sum()
    total_dalam_proses = filtered_df['total_proses'].sum()

    # Membuat layout untuk menampilkan angka
    fig = go.Figure()

    # Menambahkan kotak dengan total izin diajukan
    fig.add_trace(go.Indicator(
        mode="number+delta",
        value=total_izin_diajukan,
        title={"text": "Total Izin Diajukan"},
        domain={'row': 0, 'column': 0}
    ))

    # Menambahkan kotak dengan total selesai
    fig.add_trace(go.Indicator(
        mode="number+delta",
        value=total_selesai,
        title={"text": "Total Selesai Diproses"},
        domain={'row': 0, 'column': 1}
    ))

    # Menambahkan kotak dengan total ditolak & dibatalkan
    fig.add_trace(go.Indicator(
        mode="number+delta",
        value=total_ditolak_dibatalkan,
        title={"text": "Total Ditolak & Dibatalkan"},
        domain={'row': 1, 'column': 0}
    ))

    # Menambahkan kotak dengan total dalam proses
    fig.add_trace(go.Indicator(
        mode="number+delta",
        value=total_dalam_proses,
        title={"text": "Total Masih Diproses"},
        domain={'row': 1, 'column': 1}
    ))

    # Mengatur layout untuk angka
    fig.update_layout(
        grid={'rows': 2, 'columns': 2},
        title_text="Data Izin Kantor Lurah Balimester",
        height=400
    )

    # Bagian tengah: Pie chart
    pie_data = filtered_df['Bidang_Recode'].value_counts()
    fig.add_trace(go.Pie(
        labels=pie_data.index,
        values=pie_data.values,
        title='Kategori Bidang Izin yang Dominan',
        domain={'x': [0.1, 0.9], 'y': [0.4, 1]},
    ))

    # Bagian bawah: Stacked bar chart
    stacked_data = filtered_df.groupby('tipe_permohonan').size().reset_index(name='count')

    fig.add_trace(go.Bar(
        x=stacked_data['tipe_permohonan'],
        y=stacked_data['count'],
        name='Jumlah Permohonan',
        marker_color='blue'
    ))

    # Mengatur layout untuk stacked bar chart
    fig.update_layout(
        title_text='Tipe Permohonan',
        xaxis_title='Tipe Permohonan',
        yaxis_title='Jumlah',
        height=600
    )

    # Menampilkan figure
    fig.show()